# =========================
# kube-prometheus-stack (alias: kps)
# =========================
kps:
  grafana:
    adminUser: admin
    adminPassword: "grafana1234!"

    service:
      type: NodePort
      nodePort: 32000

    sidecar:
      datasources:
        enabled: true
        label: grafana_datasource
      dashboards:
        enabled: true
        label: grafana_dashboard

  prometheus:
    service:
      type: NodePort
      nodePort: 32001

  alertmanager:
    service:
      type: NodePort
      nodePort: 32002

# =========================
# Loki (single binary, local filesystem)
# =========================
loki:
  deploymentMode: SingleBinary

  loki:
    auth_enabled: false

    # (Loki 버전에 따라 structured metadata 검증 때문에 터지는 경우 방지용)
    limits_config:
      allow_structured_metadata: false

    commonConfig:
      replication_factor: 1

    schemaConfig:
      configs:
        - from: "2024-01-01"
          store: boltdb-shipper
          object_store: filesystem
          schema: v13
          index:
            prefix: loki_index_
            period: 24h

    storage:
      type: filesystem

    # (옵션) ruler 저장소 모듈 때문에 죽는 경우 방지용
    # - 지금 에러가 ruler-storage에서 터졌으니, 데모/프로젝트에서는 꺼두는 게 안정적
    ruler:
      enable_api: false

  singleBinary:
    replicas: 1
    persistence:
      enabled: false

    # ✅ 핵심: /var/loki 가 read-only라서 CrashLoop 났던 것 해결
    # EmptyDir로 /var/loki 를 덮어씌워서 writable 경로 제공
    extraVolumes:
      - name: loki-data
        emptyDir: {}

    extraVolumeMounts:
      - name: loki-data
        mountPath: /var/loki

  # simple scalable 끄기(충돌/검증 에러 방지)
  read:
    enabled: false
  write:
    enabled: false
  backend:
    enabled: false

  # 불필요 컴포넌트 끄기(싱글노드에서 리소스 폭발 방지)
  lokiCanary:
    enabled: false
  gateway:
    enabled: false

  monitoring:
    selfMonitoring:
      enabled: false

  test:
    enabled: false
